<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Carga vs VMP</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(drawChart);

      async function drawChart() {
        const response = await fetch("https://script.google.com/macros/s/AKfycbz1UMEtWPPXua2EY_CVuCoXjAl414Y9QaooxqBDw5mrvLParCWtVhvl-8w0WpLkCkOzEA/exec");
        const rawData = await response.json();

        const data1 = [], data2 = [];

        rawData.slice(1).forEach(row => {
          const [x, y1, y2] = row;
          if (!isNaN(x) && !isNaN(y1)) data1.push([x, y1]);
          if (!isNaN(x) && !isNaN(y2)) data2.push([x, y2]);
        });

        function getRegressionLine(data) {
          const n = data.length;
          const sumX = data.reduce((a, b) => a + b[0], 0);
          const sumY = data.reduce((a, b) => a + b[1], 0);
          const sumXY = data.reduce((a, b) => a + b[0] * b[1], 0);
          const sumX2 = data.reduce((a, b) => a + b[0] * b[0], 0);
          const meanY = sumY / n;

          const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
          const intercept = (sumY - slope * sumX) / n;

          const ssTotal = data.reduce((a, b) => a + Math.pow(b[1] - meanY, 2), 0);
          const ssRes = data.reduce((a, b) => a + Math.pow(b[1] - (slope * b[0] + intercept), 2), 0);
          const r2 = 1 - ssRes / ssTotal;

          return { slope, intercept, r2 };
        }

        const reg1 = getRegressionLine(data1);
        const reg2 = getRegressionLine(data2);

        const data = new google.visualization.DataTable();
        data.addColumn('number', 'VMP');
        data.addColumn('number', 'Serie 1');
        data.addColumn('number', 'Serie 2');
        data.addColumn({ type: 'string', role: 'annotation' });

        for (let i = 0; i < Math.max(data1.length, data2.length); i++) {
          const x1 = data1[i]?.[0] ?? null;
          const y1 = data1[i]?.[1] ?? null;
          const x2 = data2[i]?.[0] ?? null;
          const y2 = data2[i]?.[1] ?? null;

          let annotation = null;
          if (i === 0) {
            annotation = `Serie 1: y = ${reg1.slope.toFixed(2)}x + ${reg1.intercept.toFixed(2)}\nR² = ${reg1.r2.toFixed(3)}`;
          }
          if (i === 1) {
            annotation = `Serie 2: y = ${reg2.slope.toFixed(2)}x + ${reg2.intercept.toFixed(2)}\nR² = ${reg2.r2.toFixed(3)}`;
          }

          const x = x1 ?? x2;
          const yA = y1 ?? null;
          const yB = y2 ?? null;

          data.addRow([x, yA, yB, annotation]);
        }

        const options = {
          title: 'Carga vs X',
          hAxis: { title: 'VMP (m/s)' },
          vAxis: { title: 'Carga (Kg)' },
          legend: { position: 'bottom' },
          pointSize: 6,
          series: {
            0: {
              color: 'blue',
              trendlines: {
                0: {
                  type: 'linear',
                  color: 'blue',
                  visibleInLegend: true,
                  lineWidth: 2
                }
              }
            },
            1: {
              color: 'red',
              trendlines: {
                0: {
                  type: 'linear',
                  color: 'red',
                  visibleInLegend: true,
                  lineWidth: 2
                }
              }
            }
          }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      }
    </script>
  </head>
  <body>
    <div id="chart_div" style="width: 1000px; height: 600px;"></div>
  </body>
</html>
