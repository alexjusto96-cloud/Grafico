<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Carga vs VMP</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(drawChart);

      async function drawChart() {
        const response = await fetch(
          "https://script.google.com/macros/s/AKfycbz1UMEtWPPXua2EY_CVuCoXjAl414Y9QaooxqBDw5mrvLParCWtVhvl-8w0WpLkCkOzEA/exec"
        );
        const rawData = await response.json();

        const header = rawData[0];
        const dataArray = rawData.slice(1);

        const serie1 = [];
        const serie2 = [];

        dataArray.forEach(row => {
          const [x, y1, y2] = row;
          if (y1 !== null) serie1.push([x, y1]);
          if (y2 !== null) serie2.push([x, y2]);
        });

        function regression(points) {
          const n = points.length;
          const sumX = points.reduce((a, p) => a + p[0], 0);
          const sumY = points.reduce((a, p) => a + p[1], 0);
          const sumXY = points.reduce((a, p) => a + p[0] * p[1], 0);
          const sumXX = points.reduce((a, p) => a + p[0] * p[0], 0);
          const meanY = sumY / n;

          const m = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
          const b = (sumY - m * sumX) / n;

          const ssTot = points.reduce((a, p) => a + Math.pow(p[1] - meanY, 2), 0);
          const ssRes = points.reduce((a, p) => a + Math.pow(p[1] - (m * p[0] + b), 2), 0);
          const r2 = 1 - ssRes / ssTot;

          return { m, b, r2 };
        }

        const reg1 = regression(serie1);
        const reg2 = regression(serie2);

        const annotation1 = `y = ${reg1.m.toFixed(2)}x + ${reg1.b.toFixed(2)}\nR² = ${reg1.r2.toFixed(3)}`;
        const annotation2 = `y = ${reg2.m.toFixed(2)}x + ${reg2.b.toFixed(2)}\nR² = ${reg2.r2.toFixed(3)}`;

        // Construir la DataTable
        const data = new google.visualization.DataTable();
        data.addColumn('number', 'VMP');
        data.addColumn('number', 'Serie 1');
        data.addColumn('number', 'Serie 2');
        data.addColumn({ type: 'string', role: 'annotation' });

        for (let i = 0; i < dataArray.length; i++) {
          const [x, y1, y2] = dataArray[i];
          let annotation = null;
          if (i === 0) annotation = annotation1;
          if (i === 1) annotation = annotation2;
          data.addRow([x, y1, y2, annotation]);
        }

        const options = {
          title: 'Carga vs X',
          hAxis: { title: 'VMP (m/s)' },
          vAxis: { title: 'Carga (Kg)' },
          legend: { position: 'bottom' },
          pointSize: 6,
          series: {
            0: {
              color: 'blue',
              trendlines: {
                0: {
                  type: 'linear',
                  color: 'blue',
                  visibleInLegend: true,
                  lineWidth: 2,
                }
              }
            },
            1: {
              color: 'red',
              trendlines: {
                0: {
                  type: 'linear',
                  color: 'red',
                  visibleInLegend: true,
                  lineWidth: 2,
                }
              }
            }
          }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      }
    </script>
  </head>
  <body>
    <div id="chart_div" style="width: 900px; height: 600px;"></div>
  </body>
</html>

