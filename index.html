<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Carga vs VMP</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {packages: ['corechart']});
      google.charts.setOnLoadCallback(drawChart);

      async function drawChart() {
        const response = await fetch(
          "https://script.google.com/macros/s/AKfycbz1UMEtWPPXua2EY_CVuCoXjAl414Y9QaooxqBDw5mrvLParCWtVhvl-8w0WpLkCkOzEA/exec"
        );
        const rawData = await response.json();

        const data = google.visualization.arrayToDataTable(rawData);

        // Extraer datos por separado
        const serie1 = [];
        const serie2 = [];

        for (let i = 1; i < rawData.length; i++) {
          const [x, y1, y2] = rawData[i];
          if (y1 !== null) serie1.push([x, y1]);
          if (y2 !== null) serie2.push([x, y2]);
        }

        // Función para calcular regresión lineal
        function linearRegression(points) {
          const n = points.length;
          const sumX = points.reduce((sum, p) => sum + p[0], 0);
          const sumY = points.reduce((sum, p) => sum + p[1], 0);
          const sumXY = points.reduce((sum, p) => sum + p[0] * p[1], 0);
          const sumXX = points.reduce((sum, p) => sum + p[0] * p[0], 0);
          const meanY = sumY / n;

          const m = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
          const b = (sumY - m * sumX) / n;

          // Calcular R²
          const ssTot = points.reduce((sum, p) => sum + Math.pow(p[1] - meanY, 2), 0);
          const ssRes = points.reduce((sum, p) => sum + Math.pow(p[1] - (m * p[0] + b), 2), 0);
          const r2 = 1 - ssRes / ssTot;

          return { m, b, r2 };
        }

        const reg1 = linearRegression(serie1);
        const reg2 = linearRegression(serie2);

        const options = {
          title: 'Carga vs X',
          hAxis: { title: 'VMP (m/s)' },
          vAxis: { title: 'Carga (Kg)' },
          legend: { position: 'bottom' },
          series: {
            0: {
              color: 'blue',
              trendlines: {
                0: {
                  type: 'linear',
                  visibleInLegend: true,
                  labelInLegend: `Tendencia Serie 1: y = ${reg1.m.toFixed(2)}x + ${reg1.b.toFixed(2)} (R² = ${reg1.r2.toFixed(3)})`,
                  color: 'blue'
                }
              }
            },
            1: {
              color: 'red',
              trendlines: {
                0: {
                  type: 'linear',
                  visibleInLegend: true,
                  labelInLegend: `Tendencia Serie 2: y = ${reg2.m.toFixed(2)}x + ${reg2.b.toFixed(2)} (R² = ${reg2.r2.toFixed(3)})`,
                  color: 'red'
                }
              }
            }
          }
        };

        const chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      }
    </script>
  </head>
  <body>
    <div id="chart_div" style="width: 900px; height: 500px;"></div>
  </body>
</html>

