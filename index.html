<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Perfil FV</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      #chart-container {
        position: relative;
        width: 100%;
        height: 600px;
      }
      #chart_div {
        width: 100%;
        height: 100%;
      }
      #r2_label {
        position: absolute;
        top: 40px;
        right: 60px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        border: 1px solid #ccc;
        font-family: Arial, sans-serif;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div id="chart-container">
      <div id="chart_div"></div>
      <div id="r2_label"></div>
    </div>

    <script>
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
        fetch('https://script.google.com/macros/s/AKfycbz1UMEtWPPXua2EY_CVuCoXjAl414Y9QaooxqBDw5mrvLParCWtVhvl-8w0WpLkCkOzEA/exec')
          .then(response => response.json())
          .then(data => {
            const headers = data[0];
            const rows = data.slice(1);

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('number', 'VMP (m/s)');
            dataTable.addColumn('number', 'Todas las cargas');
            dataTable.addColumn('number', 'Best Profile');
            dataTable.addRows(rows);

            // Filtrar puntos válidos
            const serie1 = rows.filter(r => r[1] != null).map(r => [r[0], r[1]]);
            const serie2 = rows.filter(r => r[2] != null).map(r => [r[0], r[2]]);

            // Cálculo de regresión lineal
            const { a: m1, b: b1, r2: r21 } = regresionLineal(serie1);
            const { a: m2, b: b2, r2: r22 } = regresionLineal(serie2);

            const options = {
              title: 'Perfil FV',
              titleTextStyle: {
                bold: true,
                fontSize: 18,
                color: '#000',
                alignment: 'center'
              },
              hAxis: {
                title: 'VMP (m/s)',
                titleTextStyle: { italic: true }
              },
              vAxis: {
                title: 'Carga (Kg)',
                titleTextStyle: { italic: true }
              },
              legend: {
                position: 'bottom',
                alignment: 'center',
                textStyle: { fontSize: 13 }
              },
              series: {
                0: { color: 'blue', pointSize: 5 },
                1: { color: 'red', pointSize: 5 }
              },
              trendlines: {
                0: {
                  type: 'linear',
                  color: 'blue',
                  visibleInLegend: false,
                  lineWidth: 2
                },
                1: {
                  type: 'linear',
                  color: 'red',
                  visibleInLegend: false,
                  lineWidth: 2
                }
              },
              tooltip: { trigger: 'both' }
            };

            const chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));
            chart.draw(dataTable, options);

            // Mostrar R² y ecuaciones en esquina
            const formatNum = num => Math.abs(num) < 1e-3 ? num.toExponential(2) : num.toFixed(2);
            const signo = v => (v >= 0 ? '+' : '−');

            document.getElementById('r2_label').innerHTML = `
              <b style="color:blue">Todas las cargas</b><br>
              R² = ${r21.toFixed(3)}<br>
              y = ${formatNum(m1)}x ${signo(b1)} ${formatNum(Math.abs(b1))}<br><br>
              <b style="color:red">Best Profile</b><br>
              R² = ${r22.toFixed(3)}<br>
              y = ${formatNum(m2)}x ${signo(b2)} ${formatNum(Math.abs(b2))}
            `;
          });
      }

      function regresionLineal(puntos) {
        const n = puntos.length;
        const sumX = puntos.reduce((acc, val) => acc + val[0], 0);
        const sumY = puntos.reduce((acc, val) => acc + val[1], 0);
        const sumXY = puntos.reduce((acc, val) => acc + val[0] * val[1], 0);
        const sumX2 = puntos.reduce((acc, val) => acc + val[0] ** 2, 0);
        const sumY2 = puntos.reduce((acc, val) => acc + val[1] ** 2, 0);

        const a = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX ** 2);
        const b = (sumY - a * sumX) / n;

        const rNumer = n * sumXY - sumX * sumY;
        const rDenom = Math.sqrt((n * sumX2 - sumX ** 2) * (n * sumY2 - sumY ** 2));
        const r2 = Math.pow(rNumer / rDenom, 2);

        return { a, b, r2 };
      }
    </script>
  </body>
</html>

