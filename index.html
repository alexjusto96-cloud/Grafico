<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Carga vs VMP</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(drawChart);

      async function drawChart() {
        const response = await fetch('https://script.google.com/macros/s/AKfycbz1UMEtWPPXua2EY_CVuCoXjAl414Y9QaooxqBDw5mrvLParCWtVhvl-8w0WpLkCkOzEA/exec');
        const json = await response.json();

        const serie1 = json.serie1;
        const serie2 = json.serie2;

        function calcularRegresion(datos) {
          const n = datos.length;
          const sumX = datos.reduce((acc, p) => acc + p.x, 0);
          const sumY = datos.reduce((acc, p) => acc + p.y, 0);
          const sumXY = datos.reduce((acc, p) => acc + p.x * p.y, 0);
          const sumX2 = datos.reduce((acc, p) => acc + p.x * p.x, 0);

          const mediaX = sumX / n;
          const mediaY = sumY / n;

          const b = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
          const a = mediaY - b * mediaX;

          const yPred = datos.map(p => a + b * p.x);
          const ssTot = datos.reduce((acc, p) => acc + Math.pow(p.y - mediaY, 2), 0);
          const ssRes = datos.reduce((acc, p, i) => acc + Math.pow(p.y - yPred[i], 2), 0);
          const r2 = 1 - ssRes / ssTot;

          return { a, b, r2 };
        }

        const reg1 = calcularRegresion(serie1);
        const reg2 = calcularRegresion(serie2);

        const data = new google.visualization.DataTable();
        data.addColumn('number', 'VMP (m/s)');
        data.addColumn('number', 'Serie 1');
        data.addColumn('number', 'Serie 2');
        data.addColumn('number', 'Tendencia 1');
        data.addColumn('number', 'Tendencia 2');

        const xVals = [...new Set([...serie1.map(p => p.x), ...serie2.map(p => p.x)])].sort((a, b) => a - b);
        xVals.forEach(x => {
          const y1 = serie1.find(p => p.x === x)?.y ?? null;
          const y2 = serie2.find(p => p.x === x)?.y ?? null;
          const t1 = reg1.a + reg1.b * x;
          const t2 = reg2.a + reg2.b * x;
          data.addRow([x, y1, y2, t1, t2]);
        });

        const options = {
          title: 'Carga vs VMP',
          hAxis: { title: 'VMP (m/s)', titleTextStyle: { italic: true } },
          vAxis: { title: 'Carga (Kg)' },
          legend: { position: 'bottom' },
          series: {
            0: { pointShape: 'circle', color: 'blue', lineWidth: 0 },
            1: { pointShape: 'circle', color: 'red', lineWidth: 0 },
            2: { color: 'blue', lineWidth: 2, visibleInLegend: false },
            3: { color: 'red', lineWidth: 2, visibleInLegend: false }
          }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(data, options);

        // Mostrar ecuaciones y R2
        document.getElementById('info_div').innerHTML = `
          <p><b>Serie 1:</b> y = ${reg1.b.toFixed(2)}x + ${reg1.a.toFixed(2)} | R² = ${reg1.r2.toFixed(3)}</p>
          <p><b>Serie 2:</b> y = ${reg2.b.toFixed(2)}x + ${reg2.a.toFixed(2)} | R² = ${reg2.r2.toFixed(3)}</p>
        `;
      }
    </script>
  </head>
  <body>
    <div id="chart_div" style="width: 900px; height: 500px;"></div>
    <div id="info_div" style="margin-left: 40px; font-family: sans-serif;"></div>
  </body>
</html>
